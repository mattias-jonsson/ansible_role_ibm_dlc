---

- name: Install dependencies.
  become: true
  ansible.builtin.yum:
    name: "{{ ansible_role_ibm_dlc_dependencies }}"
    state: present

- name: Check version of IBM DLC binary.
  become: true
  ansible.builtin.shell: >
    set -o pipefail && \
      sudo yum info dlc-service | sed -n 's/^Version\s*:\s\([0-9.]*\)$/\1/p'
  args:
    warn: false
  changed_when: false
  register: installed_dlc_bin_version

- name: Check release of IBM DLC binary.
  become: true
  ansible.builtin.shell: >
    set -o pipefail && \
      sudo yum info dlc-service | sed -n 's/^Release\s*:\s\([0-9.]*\)$/\1/p'
  args:
    warn: false
  changed_when: false
  register: installed_dlc_bin_release

- name: Install block.
  when:
    - ansible_role_ibm_dlc_version != installed_dlc_bin_version.stdout
    - ansible_role_ibm_dlc_release != installed_dlc_bin_release.stdout
  block:
    - name: Upload IBM DLC package.
      become: true
      ansible.builtin.copy:
        src: '{{ ansible_role_ibm_dlc_rpm }}'
        dest: "/var/tmp/{{ 1000 | random | hash('md5') }}.rpm"
        owner: root
        group: root
        mode: '0770'
      register: ibmdlcrpmcopy

    - name: Install IBM DLC.
      become: true
      ansible.builtin.yum:
        name: '{{ ibmdlcrpmcopy.dest }}'
        state: present
        disable_gpg_check: true
        allow_downgrade: true

    - name: Cleanup temporary files.
      become: true
      ansible.builtin.file:
        path: '{{ ibmdlcrpmcopy.dest }}'
        state: absent
